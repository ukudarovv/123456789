# Техническое задание — AvtoMat MVP (Telegram-бот + Web-SRM, SQLite)

## 0. Цели и объем
- Собрать и обработать лиды по трем потокам: автошколы, инструкторы, только тесты.
- Поддержать RU/KZ интерфейсы, хранить язык в профиле.
- Хранить все данные в SRM (SQLite для MVP), выдавать каталоги, принимать лиды, вести статусы и аудит.
- Генерировать wa.me ссылки у пользователя с предзаполненным текстом.
- Собирать аналитику по ключевым шагам воронки.

## 1. Стек и общие принципы
- Bot: Python, aiogram (FSM, i18n).
- Backend: Django + DRF, БД SQLite (MVP), JSONField → TEXT.
- Auth: Bot → API по Api-Key; SRM UI — Django auth/JWT (вне рамок бота).
- HTTPS на прод. Пароли — hash (Django).
- Логи без хранения ИИН/телефонов в открытом виде (маскирование при выводе по возможности).

## 2. Архитектура (high level)
```
Telegram user → aiogram bot → SRM API (DRF) → SQLite
                            ↘ analytics_event
SRM UI (admin) → SRM API → SQLite
```
- Каталоги и справочники хранятся в SRM и выдаются боту.
- Бот создаёт лиды через POST /api/leads.
- Статусы лидов меняются вручную в SRM, история в lead_status_history.

## 3. Данные (ссылка на `docs/db_schema.md`)
- Справочники: dict_city, dict_category, dict_training_format, dict_tariff_plan.
- Каталог: school, school_tariff, instructor.
- Пользователи бота: bot_user.
- Лиды: lead, lead_status_history.
- Аналитика: analytics_event.
- Настройки/шаблоны: project_setting, whatsapp_template.
- SRM пользователи: srm_user (роль OWNER|ADMIN|SCHOOL_MANAGER).

## 4. API (ссылка на `docs/api_contracts.md`)
- GET /api/dicts/* — города, категории, форматы, тарифы.
- GET /api/schools, GET /api/schools/{id} — каталог автошкол с тарифами.
- GET /api/instructors — каталог инструкторов с фильтрами.
- GET /api/settings — цена тестов и номер владельца (WA).
- POST /api/leads — создание лида (SCHOOL/INSTRUCTOR/TESTS).
- POST /api/analytics/events — события воронки.
- SRM: GET/PATCH /api/leads, экспорт CSV, деталка лидов (для UI/Admin).

## 5. Функциональные требования (бот)
### 5.1. Общие
- /start: выбор языка RU/KZ, сохранение в bot_user; кнопка "Сменить язык".
- Главное меню: 3 интента (NO_LICENSE, REFRESH, CERT_NOT_PASSED) + быстрые входы (Автошколы, Инструкторы, Только тесты, Сменить язык).
- Навигация: "Назад", "Главное меню" на каждом шаге; сброс FSM на главное меню, язык сохраняется.
- Таймаут: при возвращении после >30 мин — предложение продолжить или начать заново (MVP — можно начать заново).

### 5.2. Поток Автошколы (SCHOOL)
1) Выбор города (из dict_city, только активные).  
2) Выбор категории (dict_category).  
3) Выбор формата (dict_training_format).  
4) Список автошкол (фильтр по городу; опц. по категории/формату).  
5) Карточка автошколы: имя, рейтинг, trust_index, адрес, ближайший набор (дата/текст), тарифы (BASIC/STANDARD/PREMIUM).  
6) Выбор тарифа (опц. если не выбран — по умолчанию первый).  
7) Форма лида: Имя (>=2, буквы/пробел/дефис), Телефон (KZ, +7/8, 10–11 цифр), кнопка "Отправить контакт".  
8) Экран подтверждения: город, категория, формат, автошкола, тариф+цена, имя, телефон.  
9) Подтвердить → POST /api/leads (type=SCHOOL, tariff_price_kzt фиксируется).  
10) Показать wa.me ссылку на номер автошколы с предзаполненным текстом (шаблон из whatsapp_template, язык юзера), кнопка "Открыть WhatsApp", кнопка "Готово" → главное меню.

### 5.3. Поток Инструкторы (INSTRUCTOR)
1) Город.  
2) Тип КПП (AT/MT).  
3) Наличие прав (bool).  
4) Пол инструктора (M/F).  
5) Список инструкторов (фильтр по city, gearbox, gender, active).  
6) Карточка: имя, пол, КПП, цена, рейтинг.  
7) Форма: Имя, Телефон (как выше), подтверждение.  
8) POST /api/leads (type=INSTRUCTOR, сохраняем gearbox, preferred_instructor_gender, has_driver_license, instructor_id).  
9) Финальный экран: подтверждение созданного лида, кнопка в главное меню.

### 5.4. Поток Только тесты (TESTS)
1) Экран описания + цена тестов (GET /api/settings).  
2) Форма: Имя, ИИН (12 цифр), Телефон, WhatsApp, Email (валидный).  
3) Подтверждение.  
4) POST /api/leads (type=TESTS, обязательны iin, whatsapp, email).  
5) Кнопка wa.me на номер владельца (OWNER_WHATSAPP_PHONE) с полями заявки.

### 5.5. Валидации
- Имя: >=2, буквы/пробел/дефис.
- Телефон: +7XXXXXXXXXX или 8XXXXXXXXXX (приводим к +7).
- ИИН: 12 цифр (только TESTS).
- Email: формат.

### 5.6. Аналитика событий
- События: start_opened, language_selected, intent_selected, flow_selected, city_selected, category_selected, format_selected, school_opened, tariff_selected, lead_form_opened, lead_submitted, whatsapp_opened, error_shown.
- Отправка в POST /api/analytics/events; payload содержит шаг/значение.

## 6. Функциональные требования (SRM / Admin)
- Авторизация: Django auth; роли: OWNER, ADMIN, SCHOOL_MANAGER.
- Раздел Заявки: таблица (имя, телефон, город, категория, тариф, тип, автошкола/инструктор, статус, дата), фильтры (статус, тип, город, автошкола, период), поиск по телефону/имени, экспорт CSV.
- Карточка заявки: все поля лида, комментарий менеджера, история статусов; смена статуса пишет lead_status_history (кто/когда/old/new/note).
- Ограничение видимости: SCHOOL_MANAGER видит только свои school_id; OWNER/ADMIN — все.
- CRUD справочников/каталогов: города, категории, форматы, тариф-планы, автошколы, тарифы автошкол, инструкторы, project_setting (цена тестов, OWNER_WHATSAPP_PHONE), whatsapp_template (scope, language).
- Активность: записи можно выключать (is_active), бот фильтрует активные.

## 7. Нефункциональные требования
- Производительность: ответы бота ≤2 c; фильтрация лидов ≤3 c при объеме до ~20k записей.
- Надежность: логирование ошибок (Sentry/лог-файл), ретраи отправки лида (2–3 раза) при 5xx/timeout.
- Безопасность: HTTPS, хеш паролей, ограничение доступа по ролям, маскирование ПДн в логах.
- Локализация: все тексты через словарь RU/KZ, включая кнопки, ошибки, шаблоны WhatsApp.

## 8. Зависимости и миграция
- SQLite в MVP; предусмотреть лёгкий переход на Postgres (избегать специфики SQLite, не использовать сложные JSON запросы).
- Миграции Django обязательны; сиды справочников (города, категории, форматы, тариф-планы).

## 9. Тестирование и приёмка
- Тестовые данные: 5–10 городов, 10–20 автошкол, тарифы, 20 инструкторов.
- E2E сценарии: по каждому потоку (валид/невалид телефон, пустые каталоги, "Назад", "Главное меню").
- Негатив: нет автошкол/инструкторов по фильтру → сообщение "Пока нет доступных вариантов..." с предложением оставить контакт (опц. лид-фолбек).
- Проверка RU/KZ текстов, wa.me ссылок (номер и текст).
- Приёмка: лид создается, виден в SRM, статус меняется и логируется, экспорт CSV работает.

## 10. Детализированные задачи (разработческие)
### Backend (Django/DRF)
- Настроить проект на SQLite, env-переменные, Api-Key middleware.
- Реализовать модели по `docs/db_schema.md`, миграции, сиды справочников.
- Сериализаторы и вьюхи: dicts, schools (+tariffs), instructors, settings, leads (POST), analytics events, leads list/detail/update, экспорт CSV.
- Permissions/filters: роль, school_id ограничение; фильтры для списков.
- Admin: кастомизация листов/фильтров/поиска, ограничение видимости для SCHOOL_MANAGER, inline для тарифов.
- Валидации: телефон, ИИН, email; обязательные поля по типу лида.
- Логирование ошибок и попыток записи лида.

### Bot (aiogram)
- Конфиг/клиент к SRM API с Api-Key.
- I18n словари RU/KZ; слой сообщений.
- FSM: common navigation, main menu, смена языка, таймаут (MVP — начало заново).
- Flows: SCHOOL, INSTRUCTOR, TESTS (шаги как в разделе 5).
- Валидации ввода; кнопка "Отправить контакт".
- Генерация wa.me (URL-encode) для школы/владельца.
- Отправка аналитики событий.
- Обработка ошибок API: ретраи 2–3 раза, дружелюбные сообщения.

### SRM UI/Admin
- Настроить доступы по ролям.
- Раздел Заявки: таблица, фильтры, поиск, экспорт CSV, смена статуса с записью истории.
- Разделы справочников/каталогов/настроек/шаблонов.

### DevOps (MVP)
- .env.example, инструкции запуска (backend, bot).
- HTTPS на прод (Nginx + certbot, если потребуется).
- Бэкап SQLite (копия файла + cron) и план восстановления.

## 11. Acceptance Criteria (резюме)
- RU/KZ выбор языка сохраняется, доступна смена.
- Все 3 потока проходят до создания лида; лид виден в SRM; кнопки wa.me открывают нужный номер с текстом.
- SRM: роли и видимость соблюдены; статус меняется и логируется; экспорт CSV работает.
- Аналитика: события пишутся на ключевых шагах.
- Валидации телефонов/ИИН/email соответствуют правилам.
- Запуск в dev по инструкции, миграции/сиды применяются.

