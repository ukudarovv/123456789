{% extends "srm_ui/base.html" %}

{% block title %}–õ–∏–¥ {{ lead.id|truncatechars:8 }} - AvtoMat SRM{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–õ–∏–¥ {{ lead.id|truncatechars:8 }}</h2>
    <a href="{% url 'srm_ui:lead_list' %}" class="btn btn-secondary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th width="200">–¢–∏–ø:</th>
                        <td><span class="badge bg-info">{{ lead.get_type_display }}</span></td>
                    </tr>
                    <tr>
                        <th>–°—Ç–∞—Ç—É—Å:</th>
                        <td>
                            {% if lead.status == "NEW" %}
                                <span class="badge bg-warning">{{ lead.get_status_display }}</span>
                            {% elif lead.status == "CONFIRMED" %}
                                <span class="badge bg-primary">{{ lead.get_status_display }}</span>
                            {% elif lead.status == "PAID" %}
                                <span class="badge bg-success">{{ lead.get_status_display }}</span>
                            {% elif lead.status == "DONE" %}
                                <span class="badge bg-dark">{{ lead.get_status_display }}</span>
                            {% elif lead.status == "CANCELED" %}
                                <span class="badge bg-danger">{{ lead.get_status_display }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ lead.get_status_display }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>–Ø–∑—ã–∫:</th>
                        <td>
                            {% if lead.language == "RU" %}
                                <span class="badge bg-info">RU</span>
                            {% elif lead.language == "KZ" %}
                                <span class="badge bg-info">KZ</span>
                            {% else %}
                                {{ lead.language }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</th>
                        <td>{{ lead.created_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                    <tr>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</th>
                        <td>{{ lead.updated_at|date:"d.m.Y H:i" }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th width="200">–ò–º—è:</th>
                        <td>{{ lead.name }}</td>
                    </tr>
                    <tr>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω:</th>
                        <td>{{ lead.phone }}</td>
                    </tr>
                    {% if lead.iin %}
                    <tr>
                        <th>–ò–ò–ù:</th>
                        <td>{{ lead.iin }}</td>
                    </tr>
                    {% endif %}
                    {% if lead.whatsapp %}
                    <tr>
                        <th>WhatsApp:</th>
                        <td>{{ lead.whatsapp }}</td>
                    </tr>
                    {% endif %}
                    {% if lead.email %}
                    <tr>
                        <th>Email:</th>
                        <td>{{ lead.email }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–±–æ—Ä–∞ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–±–æ—Ä–∞</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    {% if lead.city %}
                    <tr>
                        <th width="200">–ì–æ—Ä–æ–¥:</th>
                        <td>{{ lead.city.name_ru }}</td>
                    </tr>
                    {% endif %}
                    {% if lead.category %}
                    <tr>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</th>
                        <td>
                            {% if lead.language == "KZ" %}
                                {{ lead.category.name_kz|default:lead.category.name_ru }}
                            {% else %}
                                {{ lead.category.name_ru }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% if lead.training_format %}
                    <tr>
                        <th>–§–æ—Ä–º–∞—Ç –æ–±—É—á–µ–Ω–∏—è:</th>
                        <td>{{ lead.training_format.name_ru }}</td>
                    </tr>
                    {% endif %}
                    {% if lead.school %}
                    <tr>
                        <th>–ê–≤—Ç–æ—à–∫–æ–ª–∞:</th>
                        <td>{{ lead.school.name_ru }}</td>
                    </tr>
                    {% endif %}
                    {% if lead.tariff_plan %}
                    <tr>
                        <th>–¢–∞—Ä–∏—Ñ:</th>
                        <td>
                            {% if lead.tariff_plan.id == 1 %}
                                {% if lead.language == "KZ" %}–ù–µ–≥—ñ–∑–≥—ñ{% else %}–ë–∞–∑–æ–≤—ã–π{% endif %}
                            {% elif lead.tariff_plan.id == 2 %}
                                –°—Ç–∞–Ω–¥–∞—Ä—Ç
                            {% elif lead.tariff_plan.id == 3 %}
                                –ü—Ä–µ–º–∏—É–º
                            {% else %}
                                {{ lead.tariff_plan.code }}
                            {% endif %}
                            {% if lead.tariff_price_kzt %} ({{ lead.tariff_price_kzt }} KZT){% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% if lead.instructor %}
                    <tr>
                        <th>–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:</th>
                        <td>{{ lead.instructor.display_name }}</td>
                    </tr>
                    {% endif %}
                    {% if lead.gearbox %}
                    <tr>
                        <th>–ö–ü–ü:</th>
                        <td>{{ lead.gearbox }}</td>
                    </tr>
                    {% endif %}
                    {% if lead.preferred_instructor_gender %}
                    <tr>
                        <th>–ü–æ–ª –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞:</th>
                        <td>{{ lead.preferred_instructor_gender }}</td>
                    </tr>
                    {% endif %}
                    {% if lead.has_driver_license is not None %}
                    <tr>
                        <th>–ï—Å—Ç—å –ø—Ä–∞–≤–∞:</th>
                        <td>{% if lead.has_driver_license %}–î–∞{% else %}–ù–µ—Ç{% endif %}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
            </div>
            <div class="card-body">
                <button onclick="sendWhatsApp()" class="btn btn-success w-100 mb-2">
                    üì≤ –û—Ç–ø—Ä–∞–≤–∏—Ç—å WhatsApp
                </button>
                {% if lead.payment_link %}
                    <a href="{{ lead.payment_link }}" target="_blank" class="btn btn-info w-100 mb-2">
                        üí≥ –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <input type="text" class="form-control" id="payment_link" 
                           value="{{ lead.payment_link|default:'' }}" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É">
                </div>
                <button onclick="savePaymentLink()" class="btn btn-primary w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
        </div>

        <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'srm_ui:lead_status_update' lead.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å</label>
                        {{ status_form.new_status }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        {{ status_form.note }}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤</h5>
            </div>
            <div class="card-body">
                {% if status_history %}
                    <div class="timeline">
                        {% for history in status_history %}
                        <div class="timeline-item mb-3">
                            <div class="d-flex">
                                <div class="timeline-marker me-3">
                                    <div class="timeline-dot"></div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>
                                                {% if history.new_status == "NEW" %}
                                                    <span class="badge bg-warning">–ù–æ–≤—ã–π</span>
                                                {% elif history.new_status == "CONFIRMED" %}
                                                    <span class="badge bg-primary">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                                                {% elif history.new_status == "PAID" %}
                                                    <span class="badge bg-success">–û–ø–ª–∞—á–µ–Ω</span>
                                                {% elif history.new_status == "DONE" %}
                                                    <span class="badge bg-dark">–í—ã–ø–æ–ª–Ω–µ–Ω</span>
                                                {% elif history.new_status == "CANCELED" %}
                                                    <span class="badge bg-danger">–û—Ç–º–µ–Ω–µ–Ω</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ history.new_status }}</span>
                                                {% endif %}
                                            </strong>
                                            {% if history.old_status %}
                                                <small class="text-muted ms-2">(–±—ã–ª–æ: 
                                                    {% if history.old_status == "NEW" %}
                                                        –ù–æ–≤—ã–π
                                                    {% elif history.old_status == "CONFIRMED" %}
                                                        –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
                                                    {% elif history.old_status == "PAID" %}
                                                        –û–ø–ª–∞—á–µ–Ω
                                                    {% elif history.old_status == "DONE" %}
                                                        –í—ã–ø–æ–ª–Ω–µ–Ω
                                                    {% elif history.old_status == "CANCELED" %}
                                                        –û—Ç–º–µ–Ω–µ–Ω
                                                    {% else %}
                                                        {{ history.old_status }}
                                                    {% endif %}
                                                )</small>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ history.changed_at|date:"d.m.Y H:i" }}</small>
                                    </div>
                                    {% if history.changed_by_user %}
                                        <small class="text-muted d-block">–ò–∑–º–µ–Ω–∏–ª: {{ history.changed_by_user.username }}</small>
                                    {% endif %}
                                    {% if history.note %}
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <small>{{ history.note }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h5>
            </div>
            <div class="card-body">
                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                <form id="commentForm" class="mb-3">
                    {% csrf_token %}
                    <div class="mb-2">
                        <textarea class="form-control" id="commentText" rows="3" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                </form>
                
                <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                <div id="commentsList">
                    {% if comments %}
                        {% for comment in comments %}
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <strong>{{ comment.user.username }}</strong>
                                    <small class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                </div>
                                <p class="mb-0 mt-2">{{ comment.comment }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function sendWhatsApp() {
    fetch('{% url "srm_ui:lead_whatsapp_link" lead.id %}')
        .then(response => response.json())
        .then(data => {
            if (data.wa_link) {
                window.open(data.wa_link, '_blank');
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ WhatsApp —Å—Å—ã–ª–∫–∏');
        });
}

function savePaymentLink() {
    const link = document.getElementById('payment_link').value;
    const formData = new FormData();
    formData.append('payment_link', link);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "srm_ui:lead_payment_link_update" lead.id %}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Å—ã–ª–∫–∏');
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
document.getElementById('commentForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const commentText = document.getElementById('commentText').value;
    if (!commentText.trim()) {
        return;
    }
    
    const formData = new FormData();
    formData.append('comment', commentText);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "srm_ui:add_comment" lead.id %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å–ø–∏—Å–æ–∫
            const commentsList = document.getElementById('commentsList');
            const commentDiv = document.createElement('div');
            commentDiv.className = 'card mb-2';
            commentDiv.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <strong>${data.comment.user}</strong>
                        <small class="text-muted">${data.comment.created_at}</small>
                    </div>
                    <p class="mb-0 mt-2">${data.comment.comment}</p>
                </div>
            `;
            if (commentsList.querySelector('.text-muted')) {
                commentsList.innerHTML = '';
            }
            commentsList.insertBefore(commentDiv, commentsList.firstChild);
            document.getElementById('commentText').value = '';
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
    });
});
</script>
{% endblock %}

