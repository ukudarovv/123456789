{% extends "srm_ui/base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - AvtoMat SRM{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–î–∞—à–±–æ—Ä–¥</h2>
    <a href="{% url 'srm_ui:lead_list' %}" class="btn btn-primary">–í—Å–µ –ª–∏–¥—ã</a>
</div>

<!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">–í—Å–µ–≥–æ –ª–∏–¥–æ–≤</h5>
                <h2 class="mb-0">{{ total_leads }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">–ó–∞ —Å–µ–≥–æ–¥–Ω—è</h5>
                <h2 class="mb-0">{{ today_leads }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">–ó–∞ 30 –¥–Ω–µ–π</h5>
                <h2 class="mb-0">{{ recent_leads }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title">–ù–æ–≤—ã—Ö</h5>
                <h2 class="mb-0">{{ conversion_data.new }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- –õ–∏–¥—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–õ–∏–¥—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td>–ù–æ–≤–∞—è</td>
                        <td><span class="badge bg-warning">{{ conversion_data.new }}</span></td>
                    </tr>
                    <tr>
                        <td>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</td>
                        <td><span class="badge bg-primary">{{ conversion_data.confirmed }}</span></td>
                    </tr>
                    <tr>
                        <td>–û–ø–ª–∞—á–µ–Ω–æ</td>
                        <td><span class="badge bg-success">{{ conversion_data.paid }}</span></td>
                    </tr>
                    <tr>
                        <td>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</td>
                        <td><span class="badge bg-dark">{{ conversion_data.done }}</span></td>
                    </tr>
                    <tr>
                        <td>–û—Ç–º–µ–Ω–µ–Ω–æ</td>
                        <td><span class="badge bg-danger">{{ conversion_data.canceled }}</span></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- –õ–∏–¥—ã –ø–æ —Ç–∏–ø–∞–º -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–õ–∏–¥—ã –ø–æ —Ç–∏–ø–∞–º</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    {% for type, count in type_counts.items %}
                    <tr>
                        <td>
                            {% if type == "SCHOOL" %}
                                üè´ –ê–≤—Ç–æ—à–∫–æ–ª–∞
                            {% elif type == "INSTRUCTOR" %}
                                üöó –ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
                            {% elif type == "TESTS" %}
                                üìò –¢–µ—Å—Ç—ã
                            {% else %}
                                {{ type }}
                            {% endif %}
                        </td>
                        <td><span class="badge bg-secondary">{{ count }}</span></td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ –ª–∏–¥–æ–≤ –ø–æ –¥–Ω—è–º -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–õ–∏–¥—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h5>
            </div>
            <div class="card-body">
                <canvas id="dailyLeadsChart" height="50"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- –¢–æ–ø –≥–æ—Ä–æ–¥–æ–≤ -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–¢–æ–ø –≥–æ—Ä–æ–¥–æ–≤</h5>
            </div>
            <div class="card-body">
                {% if top_cities %}
                    <table class="table table-sm">
                        {% for city in top_cities %}
                        <tr>
                            <td>{{ city.city__name_ru }}</td>
                            <td><span class="badge bg-info">{{ city.count }}</span></td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h5>
            </div>
            <div class="card-body">
                {% if top_categories %}
                    <table class="table table-sm">
                        {% for category in top_categories %}
                        <tr>
                            <td>{{ category.category__name_ru }}</td>
                            <td><span class="badge bg-info">{{ category.count }}</span></td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–∏–¥—ã -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–∏–¥—ã</h5>
            </div>
            <div class="card-body">
                {% if latest_leads %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–ò–º—è</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in latest_leads %}
                                <tr>
                                    <td><small>{{ lead.id|truncatechars:8 }}</small></td>
                                    <td>{{ lead.name }}</td>
                                    <td>{{ lead.phone }}</td>
                                    <td>
                                        {% if lead.type == "SCHOOL" %}
                                            <span class="badge bg-info">üè´ –ê–≤—Ç–æ—à–∫–æ–ª–∞</span>
                                        {% elif lead.type == "INSTRUCTOR" %}
                                            <span class="badge bg-info">üöó –ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</span>
                                        {% elif lead.type == "TESTS" %}
                                            <span class="badge bg-info">üìò –¢–µ—Å—Ç—ã</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ lead.type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if lead.status == "NEW" %}
                                            <span class="badge bg-warning">–ù–æ–≤–∞—è</span>
                                        {% elif lead.status == "CONFIRMED" %}
                                            <span class="badge bg-primary">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</span>
                                        {% elif lead.status == "PAID" %}
                                            <span class="badge bg-success">–û–ø–ª–∞—á–µ–Ω–æ</span>
                                        {% elif lead.status == "DONE" %}
                                            <span class="badge bg-dark">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                                        {% elif lead.status == "CANCELED" %}
                                            <span class="badge bg-danger">–û—Ç–º–µ–Ω–µ–Ω–æ</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ lead.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ lead.created_at|date:"d.m.Y H:i" }}</small></td>
                                    <td>
                                        <a href="{% url 'srm_ui:lead_detail' lead.id %}" class="btn btn-sm btn-outline-primary">–û—Ç–∫—Ä—ã—Ç—å</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">–ù–µ—Ç –ª–∏–¥–æ–≤</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –ì—Ä–∞—Ñ–∏–∫ –ª–∏–¥–æ–≤ –ø–æ –¥–Ω—è–º
    const ctx = document.getElementById('dailyLeadsChart');
    if (ctx) {
        const dailyData = {{ daily_leads|safe }};
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dailyData.map(item => item.date),
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏–¥–æ–≤',
                    data: dailyData.map(item => item.count),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}

